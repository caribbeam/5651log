{% extends "log_kayit/partials/base_dashboard.html" %}
{% load static %}

{% block title %}Güvenlik Olayları - {{ company.name }}{% endblock %}

{% block extra_css %}
<style>
.events-container {
    padding: 20px;
}

.event-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: transform 0.2s ease;
}

.event-card:hover {
    transform: translateY(-2px);
}

.event-card.low { border-left-color: #28a745; }
.event-card.medium { border-left-color: #ffc107; }
.event-card.high { border-left-color: #fd7e14; }
.event-card.critical { border-left-color: #dc3545; }

.severity-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
}

.severity-low { background: #d4edda; color: #155724; }
.severity-medium { background: #fff3cd; color: #856404; }
.severity-high { background: #f8d7da; color: #721c24; }
.severity-critical { background: #f8d7da; color: #721c24; }

.event-type-badge {
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: bold;
    background: #e9ecef;
    color: #495057;
}

.timeline-item {
    position: relative;
    padding-left: 30px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #007bff;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #007bff;
}

.timeline-item::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 12px;
    width: 2px;
    height: calc(100% + 20px);
    background: #e9ecef;
}
</style>
{% endblock %}

{% block dashboard_content %}
<div class="events-container">
    <!-- Sayfa Başlığı -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>Güvenlik Olayları
            <small class="text-muted">- {{ company.name }}</small>
        </h1>
        <div>
            <a href="{% url 'firewall_management:firewall_dashboard' company.slug %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Firewall Dashboard
            </a>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt me-2"></i>Yenile
            </button>
        </div>
    </div>

    <!-- İstatistik Kartları -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-primary mb-0">{{ event_stats.total }}</div>
                    <div class="text-muted">Toplam Olay</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-warning mb-0">{{ event_stats.unresolved }}</div>
                    <div class="text-muted">Çözülmemiş</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-danger mb-0">{{ event_stats.critical }}</div>
                    <div class="text-muted">Kritik</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="h2 text-success mb-0">{{ event_stats.resolved }}</div>
                    <div class="text-muted">Çözüldü</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Olay Tipi</label>
                    <select name="event_type" class="form-select">
                        <option value="">Tümü</option>
                        <option value="RULE_MATCH" {% if filters.event_type == 'RULE_MATCH' %}selected{% endif %}>Kural Eşleşmesi</option>
                        <option value="RULE_VIOLATION" {% if filters.event_type == 'RULE_VIOLATION' %}selected{% endif %}>Kural İhlali</option>
                        <option value="ATTACK_DETECTED" {% if filters.event_type == 'ATTACK_DETECTED' %}selected{% endif %}>Saldırı Tespit Edildi</option>
                        <option value="TRAFFIC_ANOMALY" {% if filters.event_type == 'TRAFFIC_ANOMALY' %}selected{% endif %}>Trafik Anomalisi</option>
                        <option value="POLICY_UPDATE" {% if filters.event_type == 'POLICY_UPDATE' %}selected{% endif %}>Politika Güncellendi</option>
                        <option value="SYSTEM_ALERT" {% if filters.event_type == 'SYSTEM_ALERT' %}selected{% endif %}>Sistem Uyarısı</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Önem Seviyesi</label>
                    <select name="severity" class="form-select">
                        <option value="">Tümü</option>
                        <option value="LOW" {% if filters.severity == 'LOW' %}selected{% endif %}>Düşük</option>
                        <option value="MEDIUM" {% if filters.severity == 'MEDIUM' %}selected{% endif %}>Orta</option>
                        <option value="HIGH" {% if filters.severity == 'HIGH' %}selected{% endif %}>Yüksek</option>
                        <option value="CRITICAL" {% if filters.severity == 'CRITICAL' %}selected{% endif %}>Kritik</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Durum</label>
                    <select name="status" class="form-select">
                        <option value="">Tümü</option>
                        <option value="unresolved" {% if filters.status == 'unresolved' %}selected{% endif %}>Çözülmemiş</option>
                        <option value="resolved" {% if filters.status == 'resolved' %}selected{% endif %}>Çözüldü</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>Filtrele
                        </button>
                        <a href="{% url 'firewall_management:events_list' company.slug %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Temizle
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Olaylar Listesi -->
    {% if events %}
    <div class="events-list">
        {% for event in events %}
        <div class="event-card {{ event.severity|lower }}">
            <div class="row">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-2">
                        <h5 class="mb-0 me-3">{{ event.get_event_type_display }}</h5>
                        <span class="severity-badge severity-{{ event.severity|lower }}">
                            {{ event.get_severity_display }}
                        </span>
                        <span class="event-type-badge ms-2">{{ event.get_event_type_display }}</span>
                    </div>
                    <p class="mb-2">{{ event.message }}</p>
                    <div class="d-flex gap-3 text-sm text-muted">
                        <span><i class="fas fa-map-marker-alt me-1"></i>{{ event.source_ip|default:"-" }} → {{ event.destination_ip|default:"-" }}</span>
                        <span><i class="fas fa-clock me-1"></i>{{ event.timestamp|date:"d.m.Y H:i:s" }}</span>
                        {% if event.rule %}
                        <span><i class="fas fa-list-alt me-1"></i>{{ event.rule.name }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="mb-2">
                        {% if event.is_resolved %}
                        <span class="badge bg-success">Çözüldü</span>
                        {% else %}
                        <span class="badge bg-warning">Çözülmemiş</span>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2 justify-content-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewEventDetails({{ event.id }})">
                            <i class="fas fa-eye"></i>
                        </button>
                        {% if not event.is_resolved %}
                        <button class="btn btn-sm btn-outline-success" onclick="markAsResolved({{ event.id }})">
                            <i class="fas fa-check"></i>
                        </button>
                        {% endif %}
                        <a href="/admin/firewall_management/firewallevent/{{ event.id }}/change/" class="btn btn-sm btn-outline-warning">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Sayfalama -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Sayfa navigasyonu" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1&{{ request.GET.urlencode }}">&laquo; İlk</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Önceki</a>
            </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">Sayfa {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Sonraki</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&{{ request.GET.urlencode }}">Son &raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="text-center py-5">
        <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Henüz güvenlik olayı yok</h5>
        <p class="text-muted">Firewall kuralları aktif olduğunda güvenlik olayları burada görünecek.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshData() {
    location.reload();
}

function viewEventDetails(eventId) {
    // Olay detaylarını görüntüleme fonksiyonu
    console.log('Olay detayları:', eventId);
}

function markAsResolved(eventId) {
    // Olayı çözüldü olarak işaretleme fonksiyonu
    if (confirm('Bu olayı çözüldü olarak işaretlemek istediğinizden emin misiniz?')) {
        console.log('Olay çözüldü:', eventId);
        // AJAX ile durum güncelleme
        location.reload();
    }
}

// Her 30 saniyede bir otomatik yenileme
setInterval(function() {
    if (!document.hidden) {
        console.log('Events data updating...');
    }
}, 30000);
</script>
{% endblock %}
