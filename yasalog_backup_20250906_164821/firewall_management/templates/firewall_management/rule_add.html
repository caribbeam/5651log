{% extends 'log_kayit/partials/base_dashboard.html' %}
{% load static %}

{% block title %}Yeni Firewall Kuralı Ekle{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-plus"></i> Yeni Firewall Kuralı Ekle
                    </h3>
                    <div class="card-tools">
                        <a href="{% url 'firewall_management:rules_list' company.slug %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Geri Dön
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        
                        <!-- Temel Bilgiler -->
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-3"><i class="fas fa-info-circle"></i> Temel Bilgiler</h5>
                                
                                <div class="mb-3">
                                    <label for="name" class="form-label">Kural Adı <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                    <small class="form-text text-muted">Kuralın tanımlayıcı adı</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Açıklama</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="rule_type" class="form-label">Kural Türü <span class="text-danger">*</span></label>
                                    <select class="form-select" id="rule_type" name="rule_type" required>
                                        <option value="">Seçiniz...</option>
                                        {% for value, label in rule_types %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Öncelik</label>
                                    <input type="number" class="form-control" id="priority" name="priority" 
                                           value="100" min="1" max="1000">
                                    <small class="form-text text-muted">Düşük sayı = Yüksek öncelik</small>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                                        <label class="form-check-label" for="is_active">
                                            Kuralı Aktif Et
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h5 class="mb-3"><i class="fas fa-network-wired"></i> Network Bilgileri</h5>
                                
                                <div class="mb-3">
                                    <label for="protocol" class="form-label">Protokol <span class="text-danger">*</span></label>
                                    <select class="form-select" id="protocol" name="protocol" required>
                                        <option value="">Seçiniz...</option>
                                        {% for value, label in protocols %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="source_ip" class="form-label">Kaynak IP</label>
                                    <input type="text" class="form-control" id="source_ip" name="source_ip" 
                                           placeholder="192.168.1.0/24 veya ANY">
                                    <small class="form-text text-muted">IP adresi, subnet veya ANY</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="destination_ip" class="form-label">Hedef IP</label>
                                    <input type="text" class="form-control" id="destination_ip" name="destination_ip" 
                                           placeholder="10.0.0.0/8 veya ANY">
                                    <small class="form-text text-muted">IP adresi, subnet veya ANY</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="source_port" class="form-label">Kaynak Port</label>
                                    <input type="text" class="form-control" id="source_port" name="source_port" 
                                           placeholder="80,443 veya ANY">
                                    <small class="form-text text-muted">Port numarası, aralık veya ANY</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="destination_port" class="form-label">Hedef Port</label>
                                    <input type="text" class="form-control" id="destination_port" name="destination_port" 
                                           placeholder="80,443 veya ANY">
                                    <small class="form-text text-muted">Port numarası, aralık veya ANY</small>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Form Butonları -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'firewall_management:rules_list' company.slug %}" class="btn btn-secondary">
                                        <i class="fas fa-times"></i> İptal
                                    </a>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save"></i> Kaydet
                                        </button>
                                        <button type="submit" name="save_and_add_another" class="btn btn-success">
                                            <i class="fas fa-plus"></i> Kaydet ve Yeni Ekle
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Form validasyonu
document.querySelector('form').addEventListener('submit', function(e) {
    const name = document.getElementById('name').value.trim();
    const ruleType = document.getElementById('rule_type').value;
    const protocol = document.getElementById('protocol').value;
    
    if (!name) {
        alert('Kural adı gereklidir!');
        e.preventDefault();
        return;
    }
    
    if (!ruleType) {
        alert('Kural türü seçilmelidir!');
        e.preventDefault();
        return;
    }
    
    if (!protocol) {
        alert('Protokol seçilmelidir!');
        e.preventDefault();
        return;
    }
});

// IP adresi format kontrolü
function validateIP(ip) {
    if (!ip || ip === 'ANY') return true;
    
    // CIDR notation kontrolü
    if (ip.includes('/')) {
        const parts = ip.split('/');
        if (parts.length !== 2) return false;
        const ipPart = parts[0];
        const cidr = parseInt(parts[1]);
        if (cidr < 0 || cidr > 32) return false;
    }
    
    // IP adresi format kontrolü
    const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
    return ipRegex.test(ip.split('/')[0]);
}

document.getElementById('source_ip').addEventListener('blur', function() {
    const ip = this.value.trim();
    if (ip && !validateIP(ip)) {
        alert('Geçerli bir IP adresi giriniz! (örn: 192.168.1.1 veya 192.168.1.0/24)');
        this.focus();
    }
});

document.getElementById('destination_ip').addEventListener('blur', function() {
    const ip = this.value.trim();
    if (ip && !validateIP(ip)) {
        alert('Geçerli bir IP adresi giriniz! (örn: 192.168.1.1 veya 192.168.1.0/24)');
        this.focus();
    }
});
</script>
{% endblock %}
