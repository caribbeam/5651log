{% extends "log_kayit/partials/base_dashboard.html" %}
{% load static %}

{% block title %}Network Monitoring - {{ company.name }}{% endblock %}

{% block extra_css %}
<style>
.network-dashboard {
    padding: 20px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid;
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card.online { border-left-color: #28a745; }
.stat-card.offline { border-left-color: #dc3545; }
.stat-card.warning { border-left-color: #ffc107; }
.stat-card.critical { border-left-color: #dc3545; }

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.device-table {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.device-status {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
}

.status-online { background: #d4edda; color: #155724; }
.status-offline { background: #f8d7da; color: #721c24; }
.status-warning { background: #fff3cd; color: #856404; }
.status-critical { background: #f8d7da; color: #721c24; }

.progress {
    height: 20px;
    border-radius: 10px;
}

.log-item {
    padding: 10px;
    border-left: 3px solid;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

.log-debug { border-left-color: #6c757d; }
.log-info { border-left-color: #17a2b8; }
.log-warning { border-left-color: #ffc107; }
.log-error { border-left-color: #dc3545; }
.log-critical { border-left-color: #dc3545; }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="network-dashboard">
    <!-- Sayfa Başlığı -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-network-wired me-2"></i>Network Monitoring
            <small class="text-muted">- {{ company.name }}</small>
        </h1>
        <div>
            <a href="{% url 'network_monitoring:device_list' company.slug %}" class="btn btn-primary">
                <i class="fas fa-list me-2"></i>Cihaz Listesi
            </a>
            <a href="{% url 'network_monitoring:device_add' company.slug %}" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>Yeni Cihaz Ekle
            </a>
            <button class="btn btn-info" onclick="refreshData()">
                <i class="fas fa-sync-alt me-2"></i>Yenile
            </button>
            <a href="{% url 'log_kayit:company_dashboard_slug' company.slug %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Ana Dashboard
            </a>
        </div>
    </div>

    <!-- İstatistik Kartları -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card online">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-check-circle fa-2x text-success"></i>
                    </div>
                    <div>
                        <div class="stat-number text-success">{{ device_stats.online }}</div>
                        <div class="text-muted">Çevrimiçi Cihazlar</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card offline">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-times-circle fa-2x text-danger"></i>
                    </div>
                    <div>
                        <div class="stat-number text-danger">{{ device_stats.offline }}</div>
                        <div class="text-muted">Çevrimdışı Cihazlar</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card warning">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                    </div>
                    <div>
                        <div class="stat-number text-warning">{{ device_stats.warning }}</div>
                        <div class="text-muted">Uyarı Durumunda</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="stat-card critical">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <i class="fas fa-skull-crossbones fa-2x text-danger"></i>
                    </div>
                    <div>
                        <div class="stat-number text-danger">{{ device_stats.critical }}</div>
                        <div class="text-muted">Kritik Durumda</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performans Metrikleri -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-microchip me-2"></i>Ortalama CPU</h6>
                </div>
                <div class="card-body text-center">
                    <div class="h2 text-primary">{{ performance_stats.avg_cpu|floatformat:1 }}%</div>
                    <div class="progress">
                        <div class="progress-bar bg-primary" style="width: {{ performance_stats.avg_cpu }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-memory me-2"></i>Ortalama RAM</h6>
                </div>
                <div class="card-body text-center">
                    <div class="h2 text-info">{{ performance_stats.avg_memory|floatformat:1 }}%</div>
                    <div class="progress">
                        <div class="progress-bar bg-info" style="width: {{ performance_stats.avg_memory }}%"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-database me-2"></i>Toplam Cihaz</h6>
                </div>
                <div class="card-body text-center">
                    <div class="h2 text-success">{{ device_stats.total }}</div>
                    <small class="text-muted">Network Cihazı</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Cihaz Listesi -->
    <div class="card device-table mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-server me-2"></i>Network Cihazları</h6>
        </div>
        <div class="card-body">
            {% if devices %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Cihaz Adı</th>
                            <th>Tür</th>
                            <th>IP Adresi</th>
                            <th>Durum</th>
                            <th>CPU</th>
                            <th>RAM</th>
                            <th>Son Görülme</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for device in devices %}
                        <tr>
                            <td>
                                <strong>{{ device.name }}</strong>
                                {% if device.model %}
                                <br><small class="text-muted">{{ device.model }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-info">{{ device.get_device_type_display }}</span>
                            </td>
                            <td>{{ device.ip_address }}</td>
                            <td>
                                <span class="device-status status-{{ device.status|lower }}">
                                    {{ device.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar {% if device.cpu_usage > 80 %}bg-danger{% elif device.cpu_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                         style="width: {{ device.cpu_usage }}%">
                                        {{ device.cpu_usage }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar {% if device.memory_usage > 80 %}bg-danger{% elif device.memory_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                         style="width: {{ device.memory_usage }}%">
                                        {{ device.memory_usage }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ device.last_seen|timesince }} önce</td>
                            <td>
                                <a href="{% url 'network_monitoring:device_detail' device.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button class="btn btn-sm btn-success" onclick="pingDevice({{ device.id }})">
                                    <i class="fas fa-satellite-dish"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-server fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Henüz network cihazı eklenmemiş</h5>
                <p class="text-muted">İlk cihazınızı eklemek için aşağıdaki butona tıklayın.</p>
                <a href="{% url 'network_monitoring:device_add' company.slug %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>İlk Cihazı Ekle
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Performans Grafikleri -->
    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-chart-area me-2"></i>24 Saatlik Performans</h6>
                </div>
                <div class="card-body">
                    <canvas id="performanceChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Son Loglar</h6>
                </div>
                <div class="card-body">
                    {% if recent_logs %}
                    <div class="log-list">
                        {% for log in recent_logs %}
                        <div class="log-item log-{{ log.level|lower }}">
                            <div class="d-flex justify-content-between">
                                <strong>{{ log.device.name }}</strong>
                                <small class="text-muted">{{ log.timestamp|timesince }} önce</small>
                            </div>
                            <div class="text-sm">{{ log.message|truncatechars:50 }}</div>
                            <span class="badge bg-{{ log.level|lower }}">{{ log.get_level_display }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-list fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Henüz log kaydı yok</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Performans grafiği
const ctx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [{% for stat in hourly_stats %}'{{ stat.hour }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Log Sayısı',
            data: [{% for stat in hourly_stats %}{{ stat.logs_count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
        }, {
            label: 'Hata Sayısı',
            data: [{% for stat in hourly_stats %}{{ stat.errors_count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Son 24 Saat Network Aktivitesi'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Veri yenileme fonksiyonu
function refreshData() {
    location.reload();
}

// Ping cihaz fonksiyonu
function pingDevice(deviceId) {
    fetch(`/network/api/device/${deviceId}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Hata: ' + data.error);
            } else {
                alert(`Cihaz Durumu: ${data.status}\nIP: ${data.ip_address}\nCPU: ${data.cpu_usage}%\nRAM: ${data.memory_usage}%`);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ping işlemi başarısız!');
        });
}

// Her 30 saniyede bir otomatik yenileme
setInterval(function() {
    // Sadece sayfa görünürse yenile
    if (!document.hidden) {
        updateDeviceStatuses();
    }
}, 30000);

function updateDeviceStatuses() {
    // Tüm cihazların durumunu güncelle
    console.log('Device statuses updating...');
    // Bu fonksiyon gelecekte AJAX ile gerçek zamanlı güncelleme yapacak
}
</script>
{% endblock %}
