{% extends 'log_kayit/partials/base_dashboard.html' %}
{% load static %}

{% block title %}Network Cihazları{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-network-wired"></i> Network Cihazları
                    </h3>
                    <div class="card-tools">
                        <a href="{% url 'network_monitoring:device_add' company.slug %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Yeni Cihaz Ekle
                        </a>
                        <a href="{% url 'network_monitoring:network_dashboard' company.slug %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Dashboard'a Dön
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Arama ve Filtreleme -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <form method="get" class="d-flex">
                                <input type="text" name="search" class="form-control me-2" 
                                       placeholder="Cihaz adı ara..." value="{{ search }}">
                                <button type="submit" class="btn btn-outline-primary">
                                    <i class="fas fa-search"></i>
                                </button>
                            </form>
                        </div>
                        <div class="col-md-3">
                            <form method="get">
                                <select name="status" class="form-select" onchange="this.form.submit()">
                                    <option value="">Tüm Durumlar</option>
                                    {% for value, label in status_choices %}
                                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                                            {{ label }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </form>
                        </div>
                        <div class="col-md-3">
                            <div class="text-end">
                                <span class="badge bg-info">Toplam: {{ page_obj.paginator.count }} cihaz</span>
                            </div>
                        </div>
                    </div>

                    <!-- Cihaz Listesi -->
                    {% if page_obj %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Cihaz Adı</th>
                                        <th>Tür</th>
                                        <th>IP Adresi</th>
                                        <th>Durum</th>
                                        <th>CPU</th>
                                        <th>RAM</th>
                                        <th>Son Görülme</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for device in page_obj %}
                                        <tr>
                                            <td>
                                                <strong>{{ device.name }}</strong>
                                                {% if device.model %}
                                                    <br><small class="text-muted">{{ device.model }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ device.get_device_type_display }}</span>
                                            </td>
                                            <td>
                                                <code>{{ device.ip_address }}</code>
                                                {% if device.mac_address %}
                                                    <br><small class="text-muted">{{ device.mac_address }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if device.status == 'ONLINE' %}
                                                    <span class="badge bg-success">Çevrimiçi</span>
                                                {% elif device.status == 'OFFLINE' %}
                                                    <span class="badge bg-danger">Çevrimdışı</span>
                                                {% elif device.status == 'WARNING' %}
                                                    <span class="badge bg-warning">Uyarı</span>
                                                {% elif device.status == 'CRITICAL' %}
                                                    <span class="badge bg-danger">Kritik</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if device.cpu_usage > 80 %}bg-danger{% elif device.cpu_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                         style="width: {{ device.cpu_usage }}%">
                                                        {{ device.cpu_usage }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar {% if device.memory_usage > 80 %}bg-danger{% elif device.memory_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" 
                                                         style="width: {{ device.memory_usage }}%">
                                                        {{ device.memory_usage }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if device.last_seen %}
                                                    <small>{{ device.last_seen|date:"d.m.Y H:i" }}</small>
                                                {% else %}
                                                    <small class="text-muted">Bilinmiyor</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <a href="{% url 'network_monitoring:device_detail' device.id %}" 
                                                       class="btn btn-sm btn-outline-info" title="Detayları Görüntüle">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="{% url 'network_monitoring:device_edit' company.slug device.id %}" 
                                                       class="btn btn-sm btn-outline-warning" title="Düzenle">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            data-device-id="{{ device.id }}" 
                                                            data-device-name="{{ device.name }}" 
                                                            title="Sil">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Sayfalama -->
                        {% if page_obj.has_other_pages %}
                            <nav aria-label="Sayfa navigasyonu">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page=1{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">İlk</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Önceki</a>
                                        </li>
                                    {% endif %}

                                    <li class="page-item active">
                                        <span class="page-link">
                                            {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                                        </span>
                                    </li>

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Sonraki</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">Son</a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-network-wired fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Henüz cihaz eklenmemiş</h5>
                            <p class="text-muted">İlk cihazınızı eklemek için "Yeni Cihaz Ekle" butonuna tıklayın.</p>
                            <a href="{% url 'network_monitoring:device_add' company.slug %}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> İlk Cihazı Ekle
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Silme Onay Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cihazı Sil</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><strong id="deviceName"></strong> cihazını silmek istediğinizden emin misiniz?</p>
                <p class="text-danger"><small>Bu işlem geri alınamaz!</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Sil</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// jQuery yüklendiğinden emin ol
if (typeof jQuery === 'undefined') {
    console.error('jQuery is not loaded!');
    // jQuery yoksa vanilla JavaScript kullan
    document.addEventListener('DOMContentLoaded', function() {
        initDeleteButtons();
    });
} else {
    $(document).ready(function() {
        initDeleteButtons();
    });
}

function initDeleteButtons() {
    if (typeof jQuery !== 'undefined') {
        // jQuery ile event listener
        $('.btn-outline-danger').on('click', function(e) {
            e.preventDefault();
            var deviceId = $(this).data('device-id');
            var deviceName = $(this).data('device-name');
            
            if (deviceId && deviceName) {
                deleteDevice(deviceId, deviceName);
            }
        });
    } else {
        // Vanilla JavaScript ile event listener
        var deleteButtons = document.querySelectorAll('.btn-outline-danger');
        deleteButtons.forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                var deviceId = this.getAttribute('data-device-id');
                var deviceName = this.getAttribute('data-device-name');
                
                if (deviceId && deviceName) {
                    deleteDevice(deviceId, deviceName);
                }
            });
        });
    }
});

function deleteDevice(deviceId, deviceName) {
    var deleteUrl = "{% url 'network_monitoring:device_delete' company.slug 0 %}".replace('0', deviceId);
    
    if (typeof jQuery !== 'undefined') {
        // jQuery ile modal işlemleri
        $('#deviceName').text(deviceName);
        $('#deleteForm').attr('action', deleteUrl);
        
        try {
            if (typeof $('#deleteModal').modal === 'function') {
                $('#deleteModal').modal('show');
            } else {
                showModalVanilla();
            }
        } catch (error) {
            console.error('Modal error:', error);
            showFallbackConfirm(deviceName, deleteUrl);
        }
    } else {
        // Vanilla JavaScript ile modal işlemleri
        var deviceNameElement = document.getElementById('deviceName');
        var deleteForm = document.getElementById('deleteForm');
        
        if (deviceNameElement) deviceNameElement.textContent = deviceName;
        if (deleteForm) deleteForm.action = deleteUrl;
        
        showModalVanilla();
    }
    
    console.log('Delete device:', deviceId, deviceName, deleteUrl);
}

function showModalVanilla() {
    var modal = document.getElementById('deleteModal');
    if (modal) {
        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.classList.add('modal-open');
        
        // Backdrop ekle
        var backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'modal-backdrop';
        document.body.appendChild(backdrop);
    }
}

function showFallbackConfirm(deviceName, deleteUrl) {
    if (confirm(deviceName + ' cihazını silmek istediğinizden emin misiniz?')) {
        if (typeof jQuery !== 'undefined') {
            $('#deleteForm').submit();
        } else {
            var form = document.getElementById('deleteForm');
            if (form) form.submit();
        }
    }
}

// Modal kapatma fonksiyonları
if (typeof jQuery !== 'undefined') {
    $(document).on('click', '.modal .close, .modal [data-dismiss="modal"]', function() {
        closeModal();
    });
    
    $(document).on('click', '.modal-backdrop', function() {
        closeModal();
    });
} else {
    // Vanilla JavaScript ile modal kapatma
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('close') || 
            e.target.getAttribute('data-dismiss') === 'modal' ||
            e.target.classList.contains('modal-backdrop')) {
            closeModal();
        }
    });
}

function closeModal() {
    var modal = document.getElementById('deleteModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
        
        // Backdrop'u kaldır
        var backdrop = document.getElementById('modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
}
</script>
{% endblock %}
{% endblock %}
