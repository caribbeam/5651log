{% extends "log_kayit/partials/base_dashboard.html" %}
{% load static %}

{% block title %}Tehdit Detayı - {{ threat.title }} - {{ company.name }}{% endblock %}

{% block extra_css %}
<style>
    .threat-detail {
        padding: 20px 0;
    }
    
    .threat-header {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        border-left: 4px solid #007bff;
    }
    
    .threat-title {
        font-size: 1.8rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
    }
    
    .threat-meta {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        color: #666;
    }
    
    .severity-badge {
        padding: 6px 16px;
        border-radius: 25px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .severity-critical { background: #dc3545; color: white; }
    .severity-high { background: #fd7e14; color: white; }
    .severity-medium { background: #ffc107; color: #212529; }
    .severity-low { background: #28a745; color: white; }
    
    .status-badge {
        padding: 6px 16px;
        border-radius: 25px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-detected { background: #17a2b8; color: white; }
    .status-analyzing { background: #ffc107; color: #212529; }
    .status-confirmed { background: #fd7e14; color: white; }
    .status-mitigated { background: #28a745; color: white; }
    .status-resolved { background: #6c757d; color: white; }
    .status-false_positive { background: #6f42c1; color: white; }
    
    .threat-description {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .threat-details {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .detail-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #007bff;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    
    .detail-value {
        color: #333;
        font-size: 1rem;
    }
    
    .progress-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .progress-item {
        margin-bottom: 20px;
    }
    
    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    
    .progress-label {
        font-weight: 600;
        color: #495057;
    }
    
    .progress-value {
        font-weight: 600;
        color: #007bff;
    }
    
    .related-section {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .related-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #28a745;
        transition: all 0.3s ease;
    }
    
    .related-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .related-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }
    
    .related-meta {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 10px;
    }
    
    .related-description {
        color: #495057;
        margin-bottom: 10px;
    }
    
    .action-buttons {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .btn-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="threat-detail">
    {% csrf_token %}
    <!-- Tehdit Başlığı ve Meta Bilgileri -->
    <div class="threat-header">
        <div class="d-flex justify-content-between align-items-start mb-3">
            <h1 class="threat-title">{{ threat.title }}</h1>
            <div class="d-flex gap-2">
                <span class="severity-badge severity-{{ threat.severity|lower }}">{{ threat.get_severity_display }}</span>
                <span class="status-badge status-{{ threat.status|lower }}">{{ threat.get_status_display }}</span>
            </div>
        </div>
        
        <div class="threat-meta">
            <div class="meta-item">
                <i class="fas fa-tag"></i>
                <span>{{ threat.get_threat_type_display }}</span>
            </div>
            <div class="meta-item">
                <i class="fas fa-clock"></i>
                <span>Tespit: {{ threat.detection_time|date:'d.m.Y H:i' }}</span>
            </div>
            {% if threat.source_ip %}
            <div class="meta-item">
                <i class="fas fa-network-wired"></i>
                <span>Kaynak IP: {{ threat.source_ip }}</span>
            </div>
            {% endif %}
            {% if threat.destination_ip %}
            <div class="meta-item">
                <i class="fas fa-server"></i>
                <span>Hedef IP: {{ threat.destination_ip }}</span>
            </div>
            {% endif %}
            {% if threat.assigned_to %}
            <div class="meta-item">
                <i class="fas fa-user"></i>
                <span>Atanan: {{ threat.assigned_to.get_full_name|default:threat.assigned_to.username }}</span>
            </div>
            {% endif %}
        </div>
        
        <div class="d-flex gap-2">
            <a href="{% url 'security_alerts:threats_list' company.slug %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Tehdit Listesine Dön
            </a>
            <a href="{% url 'security_alerts:security_dashboard' company.slug %}" class="btn btn-outline-primary">
                <i class="fas fa-shield-alt me-2"></i>Güvenlik Dashboard
            </a>
        </div>
    </div>

    <!-- Tehdit Açıklaması -->
    <div class="threat-description">
        <h4 class="mb-3"><i class="fas fa-info-circle me-2"></i>Tehdit Açıklaması</h4>
        <p class="mb-0">{{ threat.description }}</p>
    </div>

    <!-- Tehdit Detayları -->
    <div class="threat-details">
        <h4 class="mb-3"><i class="fas fa-list me-2"></i>Tehdit Detayları</h4>
        
        <div class="detail-grid">
            <div class="detail-item">
                <div class="detail-label">Tehdit Tipi</div>
                <div class="detail-value">{{ threat.get_threat_type_display }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Önem Seviyesi</div>
                <div class="detail-value">{{ threat.get_severity_display }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Durum</div>
                <div class="detail-value">{{ threat.get_status_display }}</div>
            </div>
            <div class="detail-item">
                <div class="detail-label">Tespit Zamanı</div>
                <div class="detail-value">{{ threat.detection_time|date:'d.m.Y H:i' }}</div>
            </div>
            {% if threat.source_ip %}
            <div class="detail-item">
                <div class="detail-label">Kaynak IP</div>
                <div class="detail-value">{{ threat.source_ip }}</div>
            </div>
            {% endif %}
            {% if threat.destination_ip %}
            <div class="detail-item">
                <div class="detail-label">Hedef IP</div>
                <div class="detail-value">{{ threat.destination_ip }}</div>
            </div>
            {% endif %}
            {% if threat.assigned_to %}
            <div class="detail-item">
                <div class="detail-label">Atanan Kişi</div>
                <div class="detail-value">{{ threat.assigned_to.get_full_name|default:threat.assigned_to.username }}</div>
            </div>
            {% endif %}
            {% if threat.tags %}
            <div class="detail-item">
                <div class="detail-label">Etiketler</div>
                <div class="detail-value">{{ threat.tags }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Güven Skorları -->
    <div class="progress-section">
        <h4 class="mb-3"><i class="fas fa-chart-line me-2"></i>Güven Skorları</h4>
        
        <div class="progress-item">
            <div class="progress-header">
                <span class="progress-label">Güven Skoru</span>
                <span class="progress-value">{{ threat.confidence_score }}%</span>
            </div>
            <div class="progress" style="height: 12px;">
                <div class="progress-bar bg-success" style="width: {{ threat.confidence_score }}%"></div>
            </div>
        </div>
        
        <div class="progress-item">
            <div class="progress-header">
                <span class="progress-label">Yanlış Pozitif Olasılığı</span>
                <span class="progress-value">{{ threat.false_positive_probability }}%</span>
            </div>
            <div class="progress" style="height: 12px;">
                <div class="progress-bar bg-warning" style="width: {{ threat.false_positive_probability }}%"></div>
            </div>
        </div>
    </div>

    <!-- İlişkili Uyarılar -->
    {% if related_alerts %}
    <div class="related-section">
        <h4 class="mb-3"><i class="fas fa-bell me-2"></i>İlişkili Uyarılar ({{ related_alerts.count }})</h4>
        
        {% for alert in related_alerts %}
        <div class="related-item">
            <div class="related-title">{{ alert.title }}</div>
            <div class="related-meta">
                <span class="badge bg-{{ alert.get_priority_color }} me-2">{{ alert.get_priority_display }}</span>
                <span><i class="fas fa-clock me-1"></i>{{ alert.created_at|date:'d.m.Y H:i' }}</span>
                {% if alert.is_acknowledged %}
                <span class="badge bg-success ms-2">Kabul Edildi</span>
                {% endif %}
                {% if alert.is_resolved %}
                <span class="badge bg-secondary ms-2">Çözüldü</span>
                {% endif %}
            </div>
            <div class="related-description">{{ alert.message }}</div>
            <a href="{% url 'security_alerts:alerts_list' company.slug %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-eye me-1"></i>Uyarıyı Görüntüle
            </a>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- İlişkili Olaylar -->
    {% if related_incidents %}
    <div class="related-section">
        <h4 class="mb-3"><i class="fas fa-exclamation-circle me-2"></i>İlişkili Olaylar ({{ related_incidents.count }})</h4>
        
        {% for incident in related_incidents %}
        <div class="related-item">
            <div class="related-title">{{ incident.title }}</div>
            <div class="related-meta">
                <span class="badge bg-{{ incident.get_severity_color }} me-2">{{ incident.get_severity_display }}</span>
                <span class="badge bg-{{ incident.get_status_color }} me-2">{{ incident.get_status_display }}</span>
                <span><i class="fas fa-clock me-1"></i>{{ incident.discovered_at|date:'d.m.Y H:i' }}</span>
            </div>
            <div class="related-description">{{ incident.description }}</div>
            <a href="{% url 'security_alerts:incidents_list' company.slug %}" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-eye me-1"></i>Olayı Görüntüle
            </a>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Aksiyon Butonları -->
    <div class="action-buttons">
        <h4 class="mb-3"><i class="fas fa-tools me-2"></i>Tehdit Yönetimi</h4>
        
        <div class="btn-group">
            {% if threat.status == 'DETECTED' %}
            <button class="btn btn-warning" onclick="updateThreatStatus('ANALYZING')">
                <i class="fas fa-search me-2"></i>Analiz Et
            </button>
            {% endif %}
            
            {% if threat.status == 'ANALYZING' %}
            <button class="btn btn-info" onclick="updateThreatStatus('CONFIRMED')">
                <i class="fas fa-check me-2"></i>Tehdidi Onayla
            </button>
            <button class="btn btn-success" onclick="updateThreatStatus('MITIGATED')">
                <i class="fas fa-shield-alt me-2"></i>Azaltıldı
            </button>
            {% endif %}
            
            {% if threat.status == 'CONFIRMED' %}
            <button class="btn btn-success" onclick="updateThreatStatus('MITIGATED')">
                <i class="fas fa-shield-alt me-2"></i>Azaltıldı
            </button>
            {% endif %}
            
            {% if threat.status != 'RESOLVED' and threat.status != 'FALSE_POSITIVE' %}
            <button class="btn btn-success" onclick="updateThreatStatus('RESOLVED')">
                <i class="fas fa-check-double me-2"></i>Çözüldü
            </button>
            {% endif %}
            
            {% if threat.status != 'FALSE_POSITIVE' %}
            <button class="btn btn-secondary" onclick="updateThreatStatus('FALSE_POSITIVE')">
                <i class="fas fa-times me-2"></i>Yanlış Pozitif
            </button>
            {% endif %}
            
            <button class="btn btn-primary" onclick="assignThreat()">
                <i class="fas fa-user-plus me-2"></i>Kişi Ata
            </button>
            
            <button class="btn btn-info" onclick="addNote()">
                <i class="fas fa-sticky-note me-2"></i>Not Ekle
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tehdit ID'sini global değişken olarak tanımla
const threat = {
    id: {{ threat.id }}
};
</script>
<script>
// Tehdit durumunu güncelle
function updateThreatStatus(newStatus) {
    const statusLabels = {
        'ANALYZING': 'Analiz Ediliyor',
        'CONFIRMED': 'Onaylandı',
        'MITIGATED': 'Azaltıldı',
        'RESOLVED': 'Çözüldü',
        'FALSE_POSITIVE': 'Yanlış Pozitif'
    };
    
    if (confirm(`Bu tehdidi "${statusLabels[newStatus]}" olarak işaretlemek istediğinizden emin misiniz?`)) {
        // AJAX ile tehdit durumunu güncelle
        fetch(`/security/threats/${threat.id}/update-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Hata: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Bir hata oluştu.');
        });
    }
}

// Tehdit atama
function assignThreat() {
    const username = prompt('Atanacak kullanıcının kullanıcı adını girin:');
    if (username) {
        fetch(`/security/threats/${threat.id}/assign/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                username: username
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Hata: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Bir hata oluştu.');
        });
    }
}

// Not ekleme
function addNote() {
    const note = prompt('Eklemek istediğiniz notu girin:');
    if (note) {
        fetch(`/security/threats/${threat.id}/add-note/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                note: note
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Hata: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Bir hata oluştu.');
        });
    }
}
</script>
{% endblock %}
